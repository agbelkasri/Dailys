rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Email distribution config — readable by all authenticated users, writable only by Cloud Functions (server-side)
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions (admin SDK) can write
    }

    // Daily report documents
    match /reports/{date} {
      allow read: if request.auth != null;
      // Only Cloud Functions create the top-level report document
      allow write: if request.auth != null;

      // Section documents — authenticated users can edit unless report is locked
      match /sections/{sectionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null
          && (
            !exists(/databases/$(database)/documents/reports/$(date))
            || get(/databases/$(database)/documents/reports/$(date)).data.lockedAt == null
          );
      }

      // Audit log — authenticated users can create (append), never update or delete
      match /auditLog/{logId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if false;
      }
    }

    // Absentee records — authenticated users can read, create, update, delete
    match /absences/{absenceId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll([
             'employeeName', 'plantId', 'date', 'type',
             'laborType', 'shift', 'reason', 'duration', 'durationHours'
           ])
        && request.resource.data.date is string
        && request.resource.data.plantId in ['EAP', 'GAP', 'SLP']
        && request.resource.data.type in ['planned', 'unplanned']
        && request.resource.data.laborType in ['direct', 'indirect']
        && request.resource.data.shift in ['1st', '2nd']
        && request.resource.data.durationHours is number;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
  }
}
